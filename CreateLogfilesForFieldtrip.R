#### Creating a clean txt with trial info for import in fieldtrip 

# for simplicity we are reading in markers generated by Julia a while ago and use the information encoded in those 
# to create the txt files with all relevant information for later use 

#### Outcoming dataframe column definitions: 
## C1: known at pretest
## C2: known at 1st occurence
## C3: known at 2nd occurence
## C4: known at posttest
## C5: target (1) or filler (2)
## C6: beginning first occurence (11), end first occ (12), beginning 2nd occ (21), end 2nd occ (22)
## C7: left (1) or right(2) side of screen 
## C8: target / filler number
## C9: Filler word the target appeard together with was known (1)/ unknown (0)
## C10: first column NA or a number == trial of interest or not

# load packages 
require(here)
require(tidyr)
library(stringr)
require(data.table)

# subject numbers
A <- c(101:130, 133:137, 201, 203, 205, 207,209,211,214,218,219)

# read in the new marker file for each person and rewrite it as a text file with trialxinfo columns structure
for (i in 1:length(A)){
  pNumber <- A[i]
  setwd("//cnas.ru.nl/wrkgrp/STD-Julia-Back-Up/Create_NewMarkers/All_New_Markers_for_R")
  filename <- paste("NewMarkers_P", pNumber,".txt", sep = "")
  currentFile <- read.delim(filename,header = F, stringsAsFactors = F)
  
  # get rid of all irrelevant trials, i.e. rows that only contain S
  #subset <- as.data.frame(currentFile[grep("S_", currentFile$V1),])
  colnames(currentFile) <- c("OrigMarker")
  
  # split remaining markers
  newdataframe <- as.data.frame(str_split_fixed(as.character(currentFile$OrigMarker),"_", n = 7))

  # split column 4 even further 
  final <- cbind(read.fwf(file = textConnection(as.character(newdataframe[, 4])), 
                 widths = c(1, 1, 1, 1), colClasses = "character", 
                 col.names = c("ID1", "ID2", "ID3", "ID4")), 
        newdataframe[-1])
  
  final$V8 <- NA
  for (i in 1:nrow(final)) {
    if (is.na(final$ID1[i]) == 1) {
      final$V8[i] <- 0
    } else {
      final$V8[i] <- 1
    }
  } 
  
  # replace characters with numbers where needed
  final$V2 <-  lapply(final$V2, function(x) {gsub("c","1",x)})
  final$V2 <- lapply(final$V2, gsub, pattern = "f", replacement = "2", fixed = TRUE)
  final$V3 <- lapply(final$V3, gsub, pattern = "beg1", replacement = "11", fixed = TRUE) # beginning first occurence 
  final$V3 <- lapply(final$V3, gsub, pattern = "end1", replacement = "12", fixed = TRUE) # end first occurence 
  final$V3 <- lapply(final$V3, gsub, pattern = "beg2", replacement = "21", fixed = TRUE) # beginning second occurence 
  final$V3 <- lapply(final$V3, gsub, pattern = "end2", replacement = "22", fixed = TRUE) # beginning first occurence 
  final$V5 <- lapply(final$V5, gsub, pattern = "pos1", replacement = "1", fixed = TRUE) # left side of the screen
  final$V5 <- lapply(final$V5, gsub, pattern = "pos2", replacement = "2", fixed = TRUE) # right side of the screen
  final$V6 <- lapply(final$V6, gsub, pattern = "f", replacement = "", fixed = TRUE) # filler number
  final$V6 <- lapply(final$V6, gsub, pattern = "t", replacement = "", fixed = TRUE) # target number
  final$V7 <- lapply(final$V7, gsub, pattern = "a", replacement = "", fixed = TRUE) # Filler word the target appeard together with was known (1)/ unknown (0)
  
  for (k in 1:nrow(final)) {
   if (final$V7[k]==""){
     final$V7[k] <- NA
   } 
  }

  final <- final[,-7]
  
  as.data.frame(t(do.call(rbind.data.frame, final))) -> final2
  
  final2[final2==""]  <- NA
  #final2[is.na(final2)==1]  <- '99'
  
  print(paste(pNumber, ": ", nrow(final2)))
  
  # safe the new data frame as a txt with the participant number 
  setwd("//cnas.ru.nl/wrkgrp/STD-Julia-Back-Up/Logfiles_For_Fieldtrip")
  outfile <-  paste(pNumber, "_logfile.txt", sep = "")
  write.table(final2, outfile, quote = F, col.names=F, row.names = F, sep = "\t")
}


#### change NA to 99
# read in the new marker file for each person and rewrite it as a text file with trialxinfo columns structure
for (i in 1:length(A)){
  pNumber <- A[i]
  setwd("//cnas.ru.nl/wrkgrp/STD-Julia-Back-Up/Logfiles_For_Fieldtrip")
  infile <-  paste(pNumber, "_logfile.txt", sep = "")
  currentFile <- read.delim(infile,header = F, stringsAsFactors = F)
  currentFile[is.na(currentFile)==1] <- 99
  
  # safe the new data frame as a txt with the participant number 
  write.table(currentFile, infile, quote = F, col.names=F, row.names = F, sep = "\t")
}
